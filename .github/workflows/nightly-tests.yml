# GitHub Actions - Tests E2E Simplificados
name: üåô Nightly E2E Tests

on:
  # Programaci√≥n nocturna a las 02:00 UTC (03:00 Espa√±a invierno UTC+1)
  # NOTA: GitHub Actions tiene delays variables (15min-varias horas) - es comportamiento normal
  # DESHABILITADO: Usuario caducar√° pronto, ahorrando costes GitHub Actions
  # schedule:
  #   - cron: '0 2 * * *'

  # Ejecuci√≥n manual con opciones
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Suite de tests a ejecutar'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - qa-only
          - ppia-only
          - cucumber-only
          - playwright-only

      browser:
        description: 'Navegador para tests'
        required: true
        default: 'chrome'
        type: choice
        options:
          - chrome
          - firefox
          - both

  # Ejecuci√≥n en push a master
  push:
    branches: [ master ]

env:
  baseUrl: "https://demo.guru99."
  domain: "com"
  version: "V4"
  testUser: "mngr652417"
  testPass: "UhEpYne"

jobs:
  # ========================================
  # QA TESTS (CON LOGIN)
  # ========================================
  qa-tests:
    name: üîë QA Tests (Playwright)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      github.event.inputs.test_suite == 'all' ||
      github.event.inputs.test_suite == 'qa-only' ||
      github.event.inputs.test_suite == 'playwright-only' ||
      github.event_name != 'workflow_dispatch'

    strategy:
      matrix:
        browser:
          - ${{ github.event.inputs.browser == 'both' && fromJson('["chrome", "firefox"]') || (github.event.inputs.browser || 'chrome') }}

    steps:
      - uses: actions/checkout@v4

      - name: Create .env file
        run: |
          echo "baseUrl=${{ env.baseUrl }}" > .env
          echo "domain=${{ env.domain }}" >> .env
          echo "version=${{ env.version }}" >> .env
          echo "testUser=${{ env.testUser }}" >> .env
          echo "testPass=${{ env.testPass }}" >> .env

      - name: Build Docker image
        run: docker build -t e2e .

      - name: Run QA Tests - ${{ matrix.browser }}
        run: |
          # Setup auth + QA tests desde Docker con xvfb
          docker run --env-file .env --ipc=host --network=host --init e2e \
            xvfb-run --auto-servernum --server-args="-screen 0 1280x960x24" \
            npx playwright test --project="Setup Authentication"

          if [ "${{ matrix.browser }}" = "firefox" ]; then
            docker run --env-file .env --ipc=host --network=host --init e2e \
              xvfb-run --auto-servernum --server-args="-screen 0 1280x960x24" \
              npx playwright test --project="Login Tests Admin - Firefox"
          else
            docker run --env-file .env --ipc=host --network=host --init e2e \
              xvfb-run --auto-servernum --server-args="-screen 0 1280x960x24" \
              npx playwright test --project="Login Tests Admin - Chrome"
          fi

  # ========================================
  # PPIA TESTS (SIN LOGIN)
  # ========================================
  ppia-tests:
    name: ü§ñ PPIA Tests (Playwright)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: |
      github.event.inputs.test_suite == 'all' ||
      github.event.inputs.test_suite == 'ppia-only' ||
      github.event.inputs.test_suite == 'playwright-only' ||
      github.event_name != 'workflow_dispatch'

    strategy:
      matrix:
        browser:
          - ${{ github.event.inputs.browser == 'both' && fromJson('["chrome", "firefox"]') || (github.event.inputs.browser || 'chrome') }}

    steps:
      - uses: actions/checkout@v4

      - name: Create .env file
        run: |
          echo "baseUrl=${{ env.baseUrl }}" > .env
          echo "domain=${{ env.domain }}" >> .env
          echo "version=${{ env.version }}" >> .env
          echo "testUser=${{ env.testUser }}" >> .env
          echo "testPass=${{ env.testPass }}" >> .env

      - name: Build Docker image
        run: docker build -t e2e .

      - name: Run PPIA Tests - ${{ matrix.browser }}
        run: |
          if [ "${{ matrix.browser }}" = "firefox" ]; then
            docker run --env-file .env --ipc=host --network=host --init e2e \
              xvfb-run --auto-servernum --server-args="-screen 0 1280x960x24" \
              npx playwright test --project="Test PPIA - Firefox"
          else
            docker run --env-file .env --ipc=host --network=host --init e2e \
              xvfb-run --auto-servernum --server-args="-screen 0 1280x960x24" \
              npx playwright test --project="Test PPIA - Chrome"
          fi

  # ========================================
  # CUCUMBER BDD TESTS
  # ========================================
  cucumber-bdd-tests:
    name: ü•í Cucumber BDD Tests
    runs-on: ubuntu-latest
    timeout-minutes: 40
    if: |
      github.event.inputs.test_suite == 'all' ||
      github.event.inputs.test_suite == 'cucumber-only' ||
      github.event_name != 'workflow_dispatch'

    steps:
      - uses: actions/checkout@v4

      - name: Create .env file
        run: |
          echo "baseUrl=${{ env.baseUrl }}" > .env
          echo "domain=${{ env.domain }}" >> .env
          echo "version=${{ env.version }}" >> .env
          echo "testUser=${{ env.testUser }}" >> .env
          echo "testPass=${{ env.testPass }}" >> .env

      - name: Build Docker image
        run: docker build -t e2e .

      # NOTA: Cucumber Customer Tests removidos (usuario caducar√°, tests skipped)
      # Ver: tests/cucumber/cucumber-customer.spec.ts (marcado como .skip)

      - name: Run Cucumber BDD Tests
        run: |
          # Tests b√°sicos y completos desde Docker (con volumen para artifacts)
          docker run --env-file .env --ipc=host --network=host --init \
            -v ${{ github.workspace }}/test-results:/END2ENDTESTS/test-results \
            -v ${{ github.workspace }}/reports:/END2ENDTESTS/reports \
            e2e xvfb-run --auto-servernum --server-args="-screen 0 1280x960x24" \
            npx playwright test tests/cucumber/cucumber-basic.spec.ts
          docker run --env-file .env --ipc=host --network=host --init \
            -v ${{ github.workspace }}/test-results:/END2ENDTESTS/test-results \
            -v ${{ github.workspace }}/reports:/END2ENDTESTS/reports \
            e2e xvfb-run --auto-servernum --server-args="-screen 0 1280x960x24" \
            npx playwright test tests/cucumber/cucumber-all.spec.ts

      - name: Upload Cucumber Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cucumber-test-results
          path: |
            test-results/
            reports/
            *.png
          retention-days: 30
