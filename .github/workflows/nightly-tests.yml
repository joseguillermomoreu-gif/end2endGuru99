# GitHub Actions - Tests E2E Simplificados
name: ðŸŒ™ Nightly E2E Tests

on:
  # ProgramaciÃ³n nocturna a las 02:00 UTC (03:00 EspaÃ±a invierno UTC+1)
  # NOTA: GitHub Actions tiene delays variables (15min-varias horas) - es comportamiento normal
  schedule:
    - cron: '0 2 * * *'

  # EjecuciÃ³n manual con opciones
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Suite de tests a ejecutar'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - qa-only
          - ppia-only
          - cucumber-only
          - playwright-only

      browser:
        description: 'Navegador para tests'
        required: true
        default: 'chrome'
        type: choice
        options:
          - chrome
          - firefox
          - both

  # EjecuciÃ³n en push a master
  push:
    branches: [ master ]

env:
  baseUrl: "https://demo.guru99."
  testUser: "mngr652417"
  testPass: "UhEpYne"

jobs:
  # ========================================
  # QA TESTS (CON LOGIN)
  # ========================================
  qa-tests:
    name: ðŸ”‘ QA Tests (Playwright)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    if: |
      github.event.inputs.test_suite == 'all' ||
      github.event.inputs.test_suite == 'qa-only' ||
      github.event.inputs.test_suite == 'playwright-only' ||
      github.event_name != 'workflow_dispatch'

    strategy:
      matrix:
        browser:
          - ${{ github.event.inputs.browser == 'both' && fromJson('["chrome", "firefox"]') || (github.event.inputs.browser || 'chrome') }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install --with-deps

      - name: Run QA Tests - ${{ matrix.browser }}
        run: |
          # Setup auth + Customer tests en un solo paso
          npx playwright test --project="Setup Authentication"
          if [ "${{ matrix.browser }}" = "firefox" ]; then
            npx playwright test --project="Login Tests Admin - Firefox"
          else
            npx playwright test --project="Login Tests Admin - Chrome"
          fi

  # ========================================
  # PPIA TESTS (SIN LOGIN)
  # ========================================
  ppia-tests:
    name: ðŸ¤– PPIA Tests (Playwright)
    runs-on: ubuntu-latest
    timeout-minutes: 45
    if: |
      github.event.inputs.test_suite == 'all' ||
      github.event.inputs.test_suite == 'ppia-only' ||
      github.event.inputs.test_suite == 'playwright-only' ||
      github.event_name != 'workflow_dispatch'

    strategy:
      matrix:
        browser:
          - ${{ github.event.inputs.browser == 'both' && fromJson('["chrome", "firefox"]') || (github.event.inputs.browser || 'chrome') }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright
        run: npx playwright install --with-deps

      - name: Run PPIA Tests - ${{ matrix.browser }}
        run: |
          if [ "${{ matrix.browser }}" = "firefox" ]; then
            npx playwright test --project="Test PPIA - Firefox"
          else
            npx playwright test --project="Test PPIA - Chrome"
          fi

  # ========================================
  # CUCUMBER BDD TESTS
  # ========================================
  cucumber-bdd-tests:
    name: ðŸ¥’ Cucumber BDD Tests
    runs-on: ubuntu-latest
    timeout-minutes: 40
    if: |
      github.event.inputs.test_suite == 'all' ||
      github.event.inputs.test_suite == 'cucumber-only' ||
      github.event_name != 'workflow_dispatch'

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright (for browser automation)
        run: npx playwright install --with-deps

      - name: Run All Cucumber BDD Tests
        run: npm run test:cucumber:all
        env:
          testUser: ${{ env.testUser }}
          testPass: ${{ env.testPass }}
          baseUrl: ${{ env.baseUrl }}

      - name: Upload Cucumber Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cucumber-test-results
          path: |
            test-results/
            reports/
            *.png
          retention-days: 30
