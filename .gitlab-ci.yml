# GitLab CI/CD - Tests E2E Simplificados
stages:
  - qa-tests
  - ppia-tests

variables:
  NODE_VERSION: "20"
  baseUrl: "https://demo.guru99.com"
  testUser: "mngr652417"
  testPass: "UhEpYne"

# Configuraci贸n de cu谩ndo ejecutar el pipeline
workflow:
  rules:
    # Programaci贸n nocturna (configurar en GitLab UI)
    - if: $CI_PIPELINE_SOURCE == "schedule"
    # Ejecuci贸n manual
    - if: $CI_PIPELINE_SOURCE == "web"
    # Push a master
    - if: $CI_COMMIT_BRANCH == "master"

# ================================================
# TEMPLATE BASE PARA TODOS LOS JOBS
# ================================================
.base_template: &base_template
  image: mcr.microsoft.com/playwright:v1.47.0-focal
  before_script:
    - npm ci
    - npx playwright install --with-deps
  cache:
    key: "$CI_COMMIT_REF_SLUG-$CI_JOB_NAME"
    paths:
      - node_modules/

# ================================================
# QA TESTS (CON LOGIN)
# ================================================
qa-tests-chrome:
  <<: *base_template
  stage: qa-tests
  script:
    - echo " Ejecutando QA Tests (Setup + Customer) - Chrome"
    - npx playwright test --project="Setup Authentication"
    - npx playwright test --project="Login Tests Admin - Chrome"
  rules:
    - if: $BROWSER == "firefox"
      when: never
    - when: always

qa-tests-firefox:
  <<: *base_template
  stage: qa-tests
  script:
    - echo " Ejecutando QA Tests (Setup + Customer) - Firefox"
    - npx playwright test --project="Setup Authentication"
    - npx playwright test --project="Login Tests Admin - Firefox"
  rules:
    - if: $BROWSER == "chrome"
      when: never
    - when: always

# ================================================
# PPIA TESTS (SIN LOGIN)
# ================================================
ppia-tests-chrome:
  <<: *base_template
  stage: ppia-tests
  script:
    - echo " Ejecutando PPIA Tests - Chrome"
    - npx playwright test --project="Test PPIA - Chrome"
  rules:
    - if: $BROWSER == "firefox"
      when: never
    - when: always

ppia-tests-firefox:
  <<: *base_template
  stage: ppia-tests
  script:
    - echo " Ejecutando PPIA Tests - Firefox"
    - npx playwright test --project="Test PPIA - Firefox"
  rules:
    - if: $BROWSER == "chrome"
      when: never
    - when: always

# ================================================
# CONFIGURAR PROGRAMACIN NOCTURNA
# ================================================
# Para configurar la ejecuci贸n a las 03:00h:
# 1. Ir a: Settings > CI/CD > Schedules
# 2. Crear "New Schedule" con:
#    - Description: "Tests E2E Nocturnos 03:00h"
#    - Interval Pattern: "0 3 * * *"
#    - Cron Timezone: Europe/Madrid
#    - Target Branch: master
#    - Variables (opcional):
#      * BROWSER: "both" (para ejecutar chrome y firefox)
